{"version":3,"sources":["../../src/engine/textlint-engine-core.js"],"names":["createFormatter","require","path","debug","TextLintEngineCore","options","executor","config","initWithAutoLoading","textlint","executeFileBackerManger","cacheBaker","cache","add","destroyCache","ruleMap","filterRuleMap","processorMap","moduleLoader","on","Event","rule","ruleName","ruleCreator","defineRule","filterRule","processor","pluginName","Processor","set","loadFromConfig","_setupRules","Error","loadPlugin","presetName","loadPreset","loadRule","loadFilterRule","textlintConfig","toJSON","setupRules","getAllRules","rulesConfig","setupFilterRules","filterRulesConfig","setupProcessors","availableExtensions","processors","reduce","constructor","concat","extensions","resetRules","filerRuleMap","files","boundLintFile","file","lintFile","execFile","onFile","patterns","targetFiles","availableFiles","unAvailableFiles","process","text","ext","boundLintText","lintText","execText","onText","actualExt","extname","length","then","result","results","formatterConfig","formatterName","color","formatter","onFormat","message","severity","error","some","messages","isErrorMessage","hasRuleAtLeastOne"],"mappings":"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","file":"textlint-engine-core.js","sourcesContent":["// LICENSE : MIT\n\"use strict\";\nconst createFormatter = require(\"textlint-formatter\");\nconst path = require(\"path\");\nconst debug = require(\"debug\")(\"textlint:engine-core\");\nimport TextLintCore from \"./../textlint-core\";\nimport RuleMap from \"./rule-map\";\nimport ProcessorMap from \"./processor-map\";\nimport Config from \"../config/config\";\nimport {pathsToGlobPatterns, findFiles, separateByAvailability} from \"../util/find-util\";\nimport TextLintModuleLoader from \"./textlint-module-loader\";\nimport ExecuteFileBackerManager from \"./execute-file-backer-manager\";\nimport CacheBaker from \"./execute-file-backers/cache-backer\";\nimport SeverityLevel from \"../shared/type/SeverityLevel\";\n/**\n * Core of TextLintEngine.\n * It is internal user.\n *\n * Hackable adaptor\n *\n * - executeOnFiles\n * - executeOnText\n * - formatResults\n *\n * There are hackable by `executor` option.\n */\nexport default class TextLintEngineCore {\n    /**\n     * Process files are wanted to lint.\n     * TextLintEngine is a wrapper of textlint.js.\n     * Aim to be called from cli with cli options.\n     * @param {Config|Object} [options] the options is command line options or Config object.\n     * @param {{ onFile: Function, onText: Function, onFormat:Function }} [executor] executor are injectable function.\n     * @constructor\n     */\n    constructor(options, executor = {}) {\n        /**\n         * @type {Config}\n         */\n        this.config = null;\n        if (options instanceof Config) {\n            // Almost internal use-case\n            this.config = options;\n        } else {\n            this.config = Config.initWithAutoLoading(options);\n        }\n\n        /**\n         * @type {TextLintCore}\n         */\n        this.textlint = new TextLintCore(this.config);\n\n        /**\n         * @type {{\n         *  onFile: function(textlint: TextlintCore):Function,\n         *  onText: function(textlint: TextlintCore):Function,\n         *  onFormat:Function}}\n         */\n        this.executor = executor;\n\n        /**\n         * @type {ExecuteFileBackerManager}\n         * @private\n         */\n        this.executeFileBackerManger = new ExecuteFileBackerManager();\n        const cacheBaker = new CacheBaker(this.config);\n        if (this.config.cache) {\n            this.executeFileBackerManger.add(cacheBaker);\n        } else {\n            cacheBaker.destroyCache();\n        }\n        /**\n         * @type {RuleMap} ruleMap is used for linting/fixer\n         * @private\n         */\n        this.ruleMap = new RuleMap();\n        /**\n         * @type {RuleMap} filerRuleMap is used for filtering\n         * @private\n         */\n        this.filterRuleMap = new RuleMap();\n        /**\n         * @type {ProcessorMap}\n         * @private\n         */\n        this.processorMap = new ProcessorMap();\n        /**\n         * @type {TextLintModuleLoader}\n         * @private\n         */\n        this.moduleLoader = new TextLintModuleLoader(this.config);\n        this.moduleLoader.on(TextLintModuleLoader.Event.rule, ([ruleName, ruleCreator]) => {\n            this.ruleMap.defineRule(ruleName, ruleCreator);\n        });\n        this.moduleLoader.on(TextLintModuleLoader.Event.filterRule, ([ruleName, ruleCreator]) => {\n            this.filterRuleMap.defineRule(ruleName, ruleCreator);\n        });\n        this.moduleLoader.on(TextLintModuleLoader.Event.processor, ([pluginName, Processor]) => {\n            this.processorMap.set(pluginName, Processor);\n        });\n        // load rule/plugin/processor\n        this.moduleLoader.loadFromConfig(this.config);\n        // set settings to textlint core\n        this._setupRules();\n    }\n\n    /**\n     * @deprecated remove this method\n     */\n    setRulesBaseDirectory() {\n        throw new Error(`Should not use setRulesBaseDirectory(), insteadof use         \nnew TextLintEngine({\n rulesBaseDirectory: directory\n})\n        `);\n    }\n\n    /**\n     * load plugin manually\n     * Note: it high cost, please use config\n     * @param {string} pluginName\n     * @deprecated use Constructor(config) insteadof it\n     */\n    loadPlugin(pluginName) {\n        this.moduleLoader.loadPlugin(pluginName);\n        this._setupRules();\n    }\n\n    /**\n     * load plugin manually\n     * Note: it high cost, please use config\n     * @param {string} presetName\n     * @deprecated use Constructor(config) insteadof it\n     */\n    loadPreset(presetName) {\n        this.moduleLoader.loadPreset(presetName);\n        this._setupRules();\n    }\n\n    /**\n     * load rule manually\n     * Note: it high cost, please use config\n     * @param {string} ruleName\n     * @deprecated use Constructor(config) insteadof it\n     */\n    loadRule(ruleName) {\n        this.moduleLoader.loadRule(ruleName);\n        this._setupRules();\n    }\n\n    /**\n     * load filter rule manually\n     * Note: it high cost, please use config\n     * @param {string} ruleName\n     * @deprecated use Constructor(config) insteadof it\n     */\n    loadFilerRule(ruleName) {\n        this.moduleLoader.loadFilterRule(ruleName);\n        this._setupRules();\n    }\n\n    /**\n     * Update rules from current config\n     * @private\n     */\n    _setupRules() {\n        // set Rules\n        const textlintConfig = this.config ? this.config.toJSON() : {};\n        this.textlint.setupRules(this.ruleMap.getAllRules(), textlintConfig.rulesConfig);\n        this.textlint.setupFilterRules(this.filterRuleMap.getAllRules(), textlintConfig.filterRulesConfig);\n        // set Processor\n        this.textlint.setupProcessors(this.processorMap.toJSON());\n        // execute files that are filtered by availableExtensions.\n        // TODO: it very hackable way, should be fixed\n        // it is depend on textlintCore's state\n        this.availableExtensions = this.textlint.processors.reduce((availableExtensions, processor) => {\n            const Processor = processor.constructor;\n            return availableExtensions.concat(Processor.availableExtensions());\n        }, this.config.extensions);\n\n    }\n\n    /**\n     * Remove all registered rule and clear messages.\n     * @private\n     */\n    resetRules() {\n        this.textlint.resetRules();\n        this.ruleMap.resetRules();\n        this.filerRuleMap.resetRules();\n    }\n\n    /**\n     * Executes the current configuration on an array of file and directory names.\n     * @param {String[]}  files An array of file and directory names.\n     * @returns {Promise<TextLintResult[]>} The results for all files that were linted.\n     */\n    executeOnFiles(files) {\n        const boundLintFile = (file) => {\n            return this.textlint.lintFile(file);\n        };\n        const execFile = typeof this.executor.onFile === \"function\"\n            ? this.executor.onFile(this.textlint)\n            : boundLintFile;\n        const patterns = pathsToGlobPatterns(files, {\n            extensions: this.availableExtensions\n        });\n        const targetFiles = findFiles(patterns);\n        // Maybe, unAvailableFilePath should be warning.\n        // But, The user can use glob pattern like `src/**/*` as arguments.\n        // pathsToGlobPatterns not modified that pattern.\n        // So, unAvailableFilePath should be ignored silently.\n        const {\n            availableFiles,\n            unAvailableFiles\n        } = separateByAvailability(targetFiles, {\n            extensions: this.availableExtensions\n        });\n        debug(\"Process files\", availableFiles);\n        debug(\"Not Process files\", unAvailableFiles);\n        return this.executeFileBackerManger.process(availableFiles, execFile);\n    }\n\n    /**\n     * If want to lint a text, use it.\n     * But, if you have a target file, use {@link executeOnFiles} instead of it.\n     * @param {string} text linting text content\n     * @param {string} ext ext is a type for linting. default: \".txt\"\n     * @returns {Promise<TextLintResult[]>}\n     */\n    executeOnText(text, ext = \".txt\") {\n        const boundLintText = (file, ext) => {\n            return this.textlint.lintText(file, ext);\n        };\n        const textlint = this.textlint;\n        const execText = typeof this.executor.onText === \"function\"\n            ? this.executor.onText(textlint)\n            : boundLintText;\n        // filePath or ext\n        const actualExt = ext[0] === \".\" ? ext : path.extname(ext);\n        if (actualExt.length === 0) {\n            throw new Error(\"should specify the extension.\\nex) .md\");\n        }\n        return execText(text, actualExt).then(result => {\n            return [result];\n        });\n    }\n\n    /**\n     * format {@link results} and return output text.\n     * @param {TextLintResult[]} results the collection of result\n     * @returns {string} formatted output text\n     * @example\n     *  console.log(formatResults(results));\n     */\n    formatResults(results) {\n        const formatterConfig = {\n            formatterName: this.config.formatterName,\n            color: this.config.color\n        };\n        const formatter = typeof this.executor.onFormat === \"function\"\n            ? this.executor.onFormat(formatterConfig)\n            : createFormatter(formatterConfig);\n        return formatter(results);\n    }\n\n    /**\n     * Checks if the given message is an error message.\n     * @param {TextLintMessage} message The message to check.\n     * @returns {boolean} Whether or not the message is an error message.\n     */\n    isErrorMessage(message) {\n        return message.severity === SeverityLevel.error;\n    }\n\n    /**\n     * Checks if the given results contain error message.\n     * If there is even one error then return true.\n     * @param {TextLintResult[]} results Linting result collection\n     * @returns {Boolean} Whether or not the results contain error message.\n     */\n    isErrorResults(results) {\n        return results.some(result => {\n            return result.messages.some(this.isErrorMessage);\n        });\n    }\n\n    /**\n     * @returns {boolean}\n     */\n    hasRuleAtLeastOne() {\n        return this.ruleMap.hasRuleAtLeastOne();\n    }\n}\n"]}